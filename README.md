# PDF MALWARE DETECTION

## Problem Statement:

Over the years, PDF has been the most widely used document format due to its portability and reliability. Unfortunately, PDF popularity and its advanced features have allowed attackers to exploit them in numerous ways. There are various critical PDF features that an attacker can misuse to deliver a malicious payload. The widespread use of PDF has installed a false impression of inherent safety among benign users. However, the characteristics of PDF motivated hackers to exploit various types of vulnerabilities, overcome security safeguards, thereby making the PDF format one of the most efficient malicious code attack vectors. Since classical analysis techniques may be limited in case of zero-days, machine-learning based techniques have emerged recently as an automatic PDF-malware detection method that is able to generalize from a set of training samples. 

The goal is to build a machine learning model which predicts whether a PDF file is benign or malicious.
There are two classes: +1 and -1.

+1: Means that the PDF file is malicious.

-1: Means that the PDF file is benign.


## Data Description

The dataset is taken from Contagio database, Evasive-PDFMal2022 which consists of 10,025 records with 5557 malicious and 4468 benign records that tend to evade the common significant features found in each class. This makes them harder to detect by common learning algorithms.

**Proposed features**

37 static representative features, including 12 general features and 25 structural features extracted from each PDF file.

#### General features
```
These features generally describe the PDF file, such as its size, whether it contains text or images, number of pages, and the title. There are 12 features from this category.

1. Number of characters in the title: Legitimate PDF files usually have a proper and more meaningful titles.
2. Metadata size: Metadata is the section where information about the PDF file is provided, which can be exploited for embedding hidden contents.
3. Document Encryption: This feature shows whether the PDF document is password protected or not.
4. Number of pages: Malicious PDF files tend to have fewer pages (most of them have one blank page) as they are not concerned about content presentation.
5. Presence of text inside the PDF: As content presentation is not the objective of malware PDF files, they may include less text in their files.
6. Size of the whole document: The malicious PDF size usually tends to vary from the benign due to its variation in page size and content.
7. Number of embedded files inside the document: PDFs are capable of attaching/embedding different types of files within themselves that might be used for exploitation, including other PDF files, doc files, images, etc.
8. Average size of all the embedded media: Embedded files in the PDF may be of various sizes depending on what they contain. The average size might lead to an insight into the content of the embedded files.
9. Number of total objects inside the PDF: As PDFs are made of objects, the number of objects combined with the rest of the features can represent the PDF in general.
10. Number of font objects: Font objects indicate the types of fonts used for the PDF text.
11. Presence of a valid PDF Header: As PDF header obfuscation is common for evading anti-virus scans, malicious PDF files tend to modify the header format.
12. Number of images in the document: PDF files may contain one or any number of images.
```
#### Structural features
```
These features describe the PDF file in terms of the structure, which requires a deeper parsing and provide an insight into the overall skeleton of the PDF. We propose a set of 25 features related to the PDF structure.

1. Number of indirect objects: This might be some indication of an obfuscation attempt.
2. Number of obfuscations: PDFs support many types of obfuscations such as string obfuscations of hex, octal etc. which are generally applied for evasion attempts.
3. Number of streams: This shows the number of sequences of binary data in the PDF.
4. Number of of endstreams: Keywords that denote the end of the streams.
5. Average Stream size: Size of the stream as the malicious code may be hidden inside streams.
6. Number of stream objects (ObjStm): Streams that contain other objects.
7. Number of Javascript keywords: This denotes the number of objects containing Javascript code, which is the most commonly exploited feature as evident.
8. Number of JS keywords: Number of objects containing Javascript code.
9. Number of Launch keywords: Launch is a keyword that can be used to execute a command or program.
10. Number of URI keywords: Indicates a presence of URL to which the PDF file attempts to connect to.
11. Number of Action keywords: Specifies a specific action upon an event.
12. Number of AA keywords: Specifies a specific action upon an event.
13. Number of OpenAction keywords: Specifies a specific action upon opening the PDF file. This feature combined with Javascript has been observed in the majority of typical malicious PDF files.
14. Number of SubmitForm tags: Indicates the PDF button that collects form information and sends them to specified destinations.
15. Number of Acroform tags: Acrobat forms are PDF files containing form fields that support scripting technologies that can be misused for attackers.
16. Total number of filters used: There are various types of compression filters applied on some PDF objects, which also might be exploited by attackers.
17. Presence of JBig2Decode filter: JBig2Decode is a common filter to encode malicious content.
18. Number of objects with nested filters: Nested filters can be an indication of evasion, as they make the decoding process more difficult.
19. XFA: XFAs are XML Form Architecture included in certain PDF 40 files that support scripting technologies that can be misused for attackers.
20. Colors: Different colors used in the PDF.
21. Trailer: Number of trailers inside the PDF.
22. Xref: Number of Xref tables.
23. Startxref: Number of keywords with ”startxref” which denotes where the Xref table is started.
24. Xref enteries: The number of entries in the PDF Xref tables as malformed Xref tables are another common observation in malicious PDF files.
25. RichMedia: Number of RichMedia keywords which denotes the number of embedded media and flash files.
```


## Data Preprocesssing

1. Performed EDA to get insight of data like:
- Identifying distribution of numerical data.
- Finding relationship between dependent and indepedent features. 
- Finding outliers and trend among data. 
- Checked for null values.
- Checked for correlation of independent features with resepect to target feature.
- Checked for imabalanced data.

2. FEATURE ENGINEERING 
- Replaced unwanted characters in the numerical features with NaN 
- Converted categorical features into numerical features 
- Handled Missing values

3. FEATURE SELECTION 
- Checked for correlation using heatmap 
- Calculated the VIF score 
- Used sklearn's feature selection techniques for classification such as mutual_info_classif and f_classif 
- Selected 20 best feature using mutual_info_classif as it measures the dependency between the variables.

4. Model Building 
- Used RandomForestClassifer for model building as it delivered the best scores as compared to other models. 
- Performed hypeterparameter tuning using RandomizeSearchCV.

5. Model Deployment 
- Model deployed to Heroku Cloud Platform





#### MLflow server command

```commandline
mlflow server \
    --backend-store-uri sqlite:///mlflow.db \
    --default-artifact-root ./artifacts \
    --host 127.0.0.1 -p 5001

```


